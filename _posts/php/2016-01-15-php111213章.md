---
layout: post
title:  "php11、12、13章"
date:   2016-01-15
categories: php
---


# 第三篇 应用篇
# 第十一章 文件系统与操作

## 目录操作
### 打开目录

```
语法：
resource opendir(string $path)
如果path不合法、权限限制或文件系统问题而不能打开目录，函数返回false，并且产生E_WARNING级别的错误信息，可以在函数前使用“@”符号抑制错误信息的输出。

一般是使用opendir时候会使用is_dir判断目录存在否
bool is_dir(string $filename)
```

```php
**检测打开**
<?php
$path = "/usr/local/apache/htdocs/php/ba";     //定义路径
if(is_dir($path)){          //判断目录是否存在
  $dir = @opendir($path) or die("不能打开" . $path . ".\n");      //如果无法打开则抛出错误信息
}else{
  echo $path . "不是合法目录路径.\n";
}
运行结果：
/usr/local/apache/htdocs/php/ba不是合法目录路径.
?>
```

### 关闭目录

```
打开目录后需要释放改目录资源
语法：
void closedir(resource $dir_handle)
$dir_handle为之前有opendir函数打开的目录返回的资源对象，改函数关闭由dir_handle所指定的目录资源对象，该资源对象之前必须被opendir打开。
```

```php
<?php
$path = "/usr/local/apache/htdocs/php/ba";        //定义打开目录
if(is_dir($path)){
  $dir = @opendir($path)  or die("不能打开" . $path . ".\n");
  closedir($dir);         //关闭目录
}else{
  echo $path . "不是合法目录路径.\n";
}
?>
```

### 读取目录

```
语法：
string readdir(resource $dir_handle)
参数$dir_handle是由opendir函数打开所返回的资源对象，该函数读取目录成功则返回目录下一个文件的文件名
```

```php
<?php
$path = "/usr/local/apache/htdocs/php/ba";
if(is_dir($path)){
  $dir = @opendir($path)  or die("不能打开" . $path . ".\n");
  while($file=readdir($dir)){
    echo $file . "\n";
  }
  closedir($dir);
}else{
  echo $path . "不是合法目录路径.\n";
}
?>
```

### 建立目录

```
bool mkdir(string $pathname[, int $mode])
pathname为要创建的目录名，mode为要创建的权限，权限是有八进制表示，该数以0开头，默认0777，函数创建成功返回bool类型true，否则返回false
```

```php
<?php
$path = "/usr/local/apache/htdocs/php/ba";
if(is_dir($path)){          //检测目录是否存在
  echo "目录：" . $path . "已存在.";
}else{
  if(mkdir($path,0777)){       //创建目录
    echo "目录：" . $path . "创建成功.\n";
  }else{
    echo "目录：" . $path . "创建失败.\n";
  }
}
```

### 删除目录

```
bool rmdir(string $dirname)
```

```php
<?php
$path = "test";
if(is_dir($path)){
  $hasDir = false;
  $dir = opendir($path);
  while($file=readdir($dir)){
    if($file <> '.' || $file <> '..'){
      $hasDir = true;
      break;
    }
  }
  closedir($dir);
  if($hasDir){
    if(rmdir($path))
    echo "目录：" . $path . "删除成功." . "\n";
    else
    echo "目录：" . $path . "删除失败" . "\n";
  }else
  echo "目录：" . $path  . "不为空，不能直接删除！";
}else {
  echo "目录" . $path .  "不是合法目录路径.\n";
}
```

### 改变目录

```
bool chdir(string $directory)

获取当前目录get_cwd
string getcwd(void)

如果改变目录成功返回当前工作目录，否则返回false
```

```php
<?php
if($path=getcwd()){
  echo "当前工作目录为："  . $path . ".\n";
  if(chdir("..")){
    echo "更改工作目录成功.\n";
    $path=getcwd();
    echo "当前工作目录为:" . $path . ".\n";
  }
}else {
  echo "获取当前目录失败.\n";
}
?>
运行结果：
当前工作目录为：/usr/local/apache/htdocs/php.
更改工作目录成功.
当前工作目录为:/usr/local/apache/htdocs.
```

## 文件操作

### 打开文件

```
语法：
resource fopen(string $filename, string $mode[, bool $use_include_path])
$filename 访问的文件名
$mode指定的访问类型
$use_include_path是否要从include_path中搜索文件
如果需要在include_path中搜索文件的话，可将use_include_path设置为1或true
为了便于程序移植，强烈建议在打开文件时总是使用“b”标记
```

|mode值|说明|
|---|---|
|r|以只读方式打开，将文件指针指向文件头|
|r+|读写方式打开，将文件指针指向文件头|
|w|写入方式打开，将文件指针指向文件头并将文件大小截为0，如果不存在就创建新文件|
|w+|读写方式打开，将文件指针指向文件头并将文件大小截为0，如果不存在就创建新文件|
|a|写入方式打开，将文件指针指向文件末尾，如果不存在就创建新文件|
|a+|读写方式打开，将文件指针指向文件末尾，如果不存在就创建新文件|
|x|创建并以写入方式打开，将文件指针指向文件头，如果文件已经存在，则fopen()调用失败并返回false，如果不存在就创建新文件|
|x+|创建并与读写方式打开，将文件指针指向文件头，如果文件已经存在，则fopen()调用失败并返回false|

```php
<?php
$file="/etc/test.txt";
$url="http://www.php.net";
if(($fh = fopen($file,'wb')) === false){      //b以二进制进行写入，防止乱码，更好的移植性
  die("采用写入方式打开文件：" . $file . "失败！\n");
}else{
  echo "采用写入方式打开文件:" . $file . "成功！\n";
}
if(($fn = fopen($url,'rb')) === false){
  die("采用只读方式读取失败:" . $url . "失败！\n");
}else{
  echo "采用只读方式读取:" .  $url . "成功! \n";
}
?>
运行结果：
采用写入方式打开文件:/etc/test.txt成功！
采用只读方式读取:http://www.php.net成功!
```

### 关闭文件

```
bool fclose(resource $handle)
$handle为打开文件资源对象，资源必须有效，且是通过fclose或fsockopen函数成功打开所返回的。函数关闭成功返回bool类型true，失败返回false
```

```php
<?php
$file = "test.txt";
if(($fh = fopen($file,'wb')) === false){
  die('采用写入方式打开文件：' .$file . '失败！\n');
}else{
  echo "采用写入方式打开文件：" .$file . "成功！\n";
}
if(fclose($fh))
  echo "文件：" . $file . "关闭成功\n";
else
  echo "文件：" . $file . "关闭失败\n";
if(($fn = fopen("http://www.baidu.com",'rb'))  === false){
  die("采用只读方式读取失败.\n");
}else{
  echo "采用只读方式成功.\n";
}
if(fclose($fn))
  echo "远程文件关闭成功\n";
else
  echo "远程文件关闭失败.\n";
?>
运行结果：
采用写入方式打开文件：test.txt成功！
文件：test.txt关闭成功
采用只读方式成功.
远程文件关闭成功
```

### 读取文件

```
string fgetc(resource $handle)
handle为要打开的文件资源，文件资源必须有效，必须指向一个由fopen函数或fsockopen函数打开且没有被关闭的文件资源。当碰到文件结束符EOF时返回false。
```

```php
//采用fgetc函数读取指定文件中得一个字符
<?php
$file = "test.txt";
if(($fh = fopen($file,'rb')) === false){
  die('采用只读方式打开文件：' . $file . '失败！\n');
}else{
  echo "采用只读方式打开" . $file . "成功\n";
}
if(($char = fgetc($fh)) === false)
  echo "读取文件：" . $file . "内容失败.\n";
else
  echo "读取文件：" . $file . "内容成功。读取内容为：" . $char . "\n";
if(fclose($fh))
  echo "文件：" . $file . "关闭成功\n";
else
  echo "文件：" . $file ."关闭失败.\n";
?>
运行结果：
采用只读方式打开test.txt成功
读取文件：test.txt内容成功。读取内容为：d
文件：test.txt关闭成功
```

```php
//读取文件的一行
//采用fgets函数读取制定文件的一行
语法：
fgets(file,length)  length，可选。规定要读取的字节数。默认是 1024 字节。

<?php
$file = "test.txt";
$fh = @fopen($file,'rb');     //可以在语句前增加@符号进行特定行隐藏
if($fh){              //如果打开为true
  echo "从文件读取的内容为：\n";    
  while(!feof($fh)){        //判断文件是否结束，feof() 函数检测是否已到达文件末尾 (eof)。
    $buffer = fgets($fh,50);    //读取文件的一行
    echo $buffer;
  }
  fclose($fh);      //关闭文件
}
?>
运行结果：
q
q
w
e
```

```
按行读取的函数fgetss和fgetcsv函数，这两个函数在使用和fgets一样，区别在于fgetss函数将从取回的一行过滤HTML标记，儿fgetcsv函数则针对CSV文件取出其中一行，并直接返回包含这些字段的一个数。
```

```
//读取任意长度文件内容
string fread(int $handle, int $length)
handle为打开文件的资源对象
length为要读取内容的长度

<?php
$file = "test.txt";
$fh = @fopen($file,'rb');
if($fh){
  echo "从文件读取的内容为：\n";
  while(!feof($fh)){
    $content .= fread($fh,50);
  }
  echo $content;
  fclose($fh);
}
?>

file_get_contents函数把一个文件内容读取至一个字符串
```

### 写入文件

```
语法：
int fwrite(resource $handle, string $string[, int $length])
resource为打开文件时返回的资源对象
string为要写入文件的字符串
length为制定长度
写入成功返回写入的字符串的字节数，写入失败返回false
```

```php
<?php
$file = "test.txt";
$string = date("Y-m-j") . "写入文件测试. \n";       //写入时间
if(is_writable($file)){           //检测文件是否可写
  if(!$fh = fopen($file, "ab")){      //如果以ab模式打开$file文件失败，执行echo，否则返回$fh资源
    echo "不能打开文件：$file \n";
    exit;
  }
  if(fwrite($fh, $string) === false){     //将$string写入资源$fh，并根据返回值给出不同提示信息，写入成功返回字符串字节数，写入失败返回false
    echo "不能写入文件：$file \n";
    exit;
  }else{
    echo "写入文件：$file  成功. \n";
      }
  }else{
    echo "文件$file不可写. \n";
}
?>

返回结果：
qs
qsdsds
wsdfdf
es
2016-01-30写入文件测试.
2016-01-30写入文件测试.


以上程序也可以改成：
<?php
$file = "test.txt";
$string = date("Y-m-j") . "写入文件测试. \n";
if(is_writable($file)){           //检测文件是否可写
  if($f = fopen($file, "ab")){
    echo "打开文件：$file  ok\n";
    //exit;                                                                                                                                                             
  }
  if(fwrite($f, $string) === false){   //将$string写入资源$fh，并根据返回值给出不同提示信息，写入成功返回字符串字节数，写入失败返回false
    echo "写入文件：$file ok \n";
    exit;
  }else{
    echo "写入文件：$file  成功. \n";
      }   
  }else{
    echo "文件$file不可写. \n";
}
运行返回：
打开文件：test.txt  ok
写入文件：test.txt  成功.
```

### 删除文件

```
bool unlink(sting $filename)
filename为要删除的文件，删除成功返回true，删除失败返回false
```

```
<?php
$file = "test.txt";
if(unlink($file)){
  echo "文件：$file删除成功. \n";
}
else{
  echo "文件：$file 删除失败. \n";
}
?>
运行结果：
文件：test.txt 删除成功.
```

### 复制文件

```
bool copy(string $source, string $dest)
source为源文件名，dest为目标文件名，复制成功返回true，复制失败返回false
需要确认目标文件夹具有可写的权限
```

```php
定义和用法
realpath() 函数返回绝对路径。
该函数删除所有符号连接（比如 '/./', '/../' 以及多余的 '/'），返回绝对路径名。
若失败，则返回 false。比如说文件不存在的话。

<?php
$file = "test.txt";
$dir = basename(realpath($file));
echo realpath("test.txt") . "\n";
if(is_writable($dir)){
  if(copy($file,'tag.txt')){
    echo "文件：$file复制成功. \n";
  }
  else {
    echo "文件:$file 复制失败 . \n";
  }
}
else {
  echo "目录: $dir 不可写 . \n";
}
?>
运行结果：
/usr/local/apache/htdocs/php/test.txt
文件: test.txt 复制成功.
```

###　移动文件和重命名文件

```
bool rename(string $oldname, string $newname)
oldname源文件，newname为目标文件，成功返回true，失败返回false
技巧:源文件和目标文件路径相同，即可实现重命名；路径不同则实现移动文件
```

```php
<?php
$scrFile = "test.txt";
$tagFile_1 = "test.log";
$tagFile_2 = dirname(realpath($file)) . DIRECTORY_SEPARATOR . $scrFile;   //目标文件
if(rename($scrFile, $tagFile_1)){
  echo "文件：$file 重命名成功 . \n";
  if(rename($tagFile_1,$tagFile_2)){
    echo "文件：$tagFile_1 移动成功 . \n";
  }else{
    echo "文件：$tagFile_1 文件移动失败 . \n";
  }
}else{
    echo "文件：$scrFile 重命名失败 . \n";
}
?>

运行结果:
文件： 重命名成功 . 
文件：test.log 移动成功 
```

### 文件的上传与下载

配置php.ini
file_uploads  默认值1，开启文件上传
upload_tmp_dir  null ,上传文件到临时目录
upload_max_filesize 2M,允许上传文件大小

需要在HTML中加入file控件，指定表达enctype属性为multipart/from-data

```html
** 客户端上传文件 **
name:index.html

<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtm11/DTD/xhtm11-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>文件上传</title>
</head>
<body>
  <form method="post" action="11.17.php" enctype="multipart/form-data">     //multipart/form-data,不对字符编码。在使用包含文件上传控件的表单时，必须使用该值。
    <input type="hidden" name="MAX_FILE_SIZE" value="30000" />          //MAX_FILE_SIZE必须放在file前，单位为字节
    请选择要上传的文件:
    <input type="file" id="upfile" name="upfile"/>
    <input type="submit" value="上传" id="submit"/>
  </form>
</body>
</html>
```

```php
name:11.17.php

<?php
header("Content-Type: text/html;charset=utf-8");        //规范为utf-8

$uploadpage = "index.html";
$dir = dirname(realpath(__FILE__)) . DIRECTORY_SEPARATOR;    //上传的文件目录
//die($dir);

$err_msg = false;
print_r($_FILES);       //测试

//判断表单是否存在
if(!isset($_FILES['upfile'])){          //$_FILES是上传文件变量数组，格式为Array ( [upfile] => Array ( [name] => 20160115_143317.jpg [type] => image/jpeg [tmp_name] => /tmp/phpIDoSXK [error] => 0 [size] => 3502037 ) ) 
  $err_msg = "表单不完全.请重新<a href='{$uploadpage}'>上传</a>\n";
}else{
  $fileImg = $_FILES['upfile'];
// print_r($fileImg);
}

//var_dump($maxUploadSize);
//echo ($fileImg['error']);
switch($fileImg['error']){
  case UPLOAD_ERR_INI_SIZE:
    $err_msg = "文件超过最大上传限制:$maxUploadSize . 请重新<a href='{$uploadpage}'>上传</a>\n";
    break;
  case UPLOAD_ERR_PARTIAL:
    $err_msg = "文件上传不完全.请重新<a href='{$uploadpage}'>上传</a>\n";
    break;
  case UPLOAD_ERR_NO_FILE:
    $err_msg = "没有选择文件.请重新<a href='{$uploadpage}'>上传</a>\n";
    break;
  case UPLOAD_ERR_FORM_SIZE:
    $err_msg = "文件超过最大上传限制.请重新<a href='{$uploadpage}'>上传</a>\n";
    break;
  case UPLOAD_ERR_CANT_WRITE:
    $err_msg = "文件写入失败.请重新<a href='{$uploadpage}'>上传</a>\n";
    break;
  case UPLOAD_ERR_NO_TMP_DIR:
    $err_msg = "没有临时文件夹.请重新<a href='{$uploadpage}'>上传</a>\n";
    break;
  case UPLOAD_ERR_OK:
    break;
  default:
    $err_msg = "未知错误.请重输<a href='{$uploadpage}'>上传</a>\n";
}
echo $err_msg;      //正常情况输出空


//判断上传文件格式
if(!in_array($fileImg['type'],array('image/jpeg','image/pjpeg','image/png'))){
  $err_msg  = "只允许上传.png或.jpg图片。请重新<a href='{$uploadpage}'>上传</a>\n";
}

//var_dump($dir.$fileImg['name']);
//echo $err_msg;
//将上传到$_FILES临时 [tmp_name]文件move到其他目录
if(!$err_msg){
  if(!move_uploaded_file($fileImg['tmp_name'],$dir.$fileImg['name'])){
    $err_msg = "移动文件失败，请重新<a href='{$uploadpage}'>上传</a>\n";
  }
}


//打开图片
if($err_msg){
  echo $err_msg;
}else{
  echo "<img src='{$fileImg['name']}' alt='上传的文件' title='上传的文件'/>";
  echo "上传成功,请继续<a href='{$uploadpage}'>上传</a>\n";
}

```

```
switch说明：

UPLOAD_ERR_OK

    Value: 0; There is no error, the file uploaded with success.
UPLOAD_ERR_INI_SIZE

    Value: 1; The uploaded file exceeds the upload_max_filesize directive in php.ini.
UPLOAD_ERR_FORM_SIZE

    Value: 2; The uploaded file exceeds the MAX_FILE_SIZE directive that was specified in the HTML form.
UPLOAD_ERR_PARTIAL

    Value: 3; The uploaded file was only partially uploaded.
UPLOAD_ERR_NO_FILE

    Value: 4; No file was uploaded.
UPLOAD_ERR_NO_TMP_DIR

    Value: 6; Missing a temporary folder. Introduced in PHP 5.0.3.
UPLOAD_ERR_CANT_WRITE

    Value: 7; Failed to write file to disk. Introduced in PHP 5.1.0.
UPLOAD_ERR_EXTENSION

    Value: 8; A PHP extension stopped the file upload. PHP does not provide a way to ascertain which extension caused the file upload to stop; examining the list of loaded extensions with phpinfo() may help. Introduced in PHP 5.2.0.
```

move_uploaded_file()定义和用法,函数将上传的文件移动到新位置,若成功，则返回 true，否则返回 false。
move_uploaded_file(file,newloc)

|语法|描述|
|---|---|
|file|规定要移动的文件|
|newloc|规定文件的新位置|


### HTML表单/按钮

```
<html>
<meta charset="UTF-8"> 
web
//按钮标签
<input type="submit" name="submit" id="submit" value="提交" />
<input type="reset" name="reset1" id="reset1" value="重写" />
<input type="button" name="button1" id="button1" value="按钮" />
//单选按钮和多选按钮
<input type="radio" name="radio1" value="v1" />
<input type="radio" name="radio1" value="v2" />
<input type="checkbox" name="checkbox1" value="c1" />
<input type="checkbox" name="checkbox1" value="c2" />
//下拉框与列表标签,size为可见项目
<select id="select1" name="select1" size="3" multiple="multiple">
  <option value="value1">value1</option>
  <option value="value2">value2</option>
  <option value="value3">value3</option>
</select>
</html>
```


### 同时上传多个文件

```
//注意：需要设置上传大小，apache的post_max_upload和php的upload_max_filesize，使用move_uploaded_file需要设置目录权限，调试php打开display_errors = on。使用echo '<pre>';使数组显示更加规整。
```

```html
*上传多个HTML*

<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtm11/DTD/xhtm11-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>文件上传</title>
</head>
<body>
  <form method="post" action="11.19.php" enctype="multipart/form-data">     <!multipart/form-data,不对字符编码。在使用包含文件上传控件的表单时，必须使用该值。>
    请选择要上传的文件:<br>
    <input type="hidden" name="MAX_FILE_SIZE" value="3000000000000" />          <!//MAX_FILE_SIZE必须放在file前，单位为字节>
    <input type="file" id="upfile1" name="upfile1[ ]"/><br/>
    <input type="hidden" name="MAX_FILE_SIZE" value="3000000000000" />          <!//MAX_FILE_SIZE必须放在file前，单位为字节>
    <input type="file" id="upfile2" name="upfile1[ ]"/><br/>
    <input type="hidden" name="MAX_FILE_SIZE" value="3000000000000" />          <!//MAX_FILE_SIZE必须放在file前，单位为字节>
    <input type="file" id="upfile3" name="upfile1[ ]"/><br/>
    <input type="hidden" name="MAX_FILE_SIZE" value="3000000000000" />          <!//MAX_FILE_SIZE必须放在file前，单位为字节>
    <input type="file" id="upfile4" name="upfile1[ ]"/><br/>
    <input type="hidden" name="MAX_FILE_SIZE" value="3000000000000" />          <!//MAX_FILE_SIZE必须放在file前，单位为字节>
    <input type="file" id="upfile5" name="upfile1[ ]"/><br/>
    <input type="submit" value="上传" id="submit"/>
  </form>
</body>
</html>

```


```php

name:11.19.php

<?php
header("Content-Type: text/html;charset=utf-8");        //规范为utf-8

$uploadpage = "index.html";
$dir = dirname(realpath(__FILE__)) . DIRECTORY_SEPARATOR;    //上传的文件目录
$maxUploadSize = ini_get('upload_max_filesize');        //从php.ini里获取参数

$err_msg = false;
echo '<pre>';print_r($_FILES);       //测试

//判断表单是否存在
if(!isset($_FILES['upfile1'])){          //$_FILES是上传文件变量数组，格式为Array ( [upfile] => Array ( [name] => 20160115_143317.jpg [type] => image/jpeg [tmp_name] => /tmp/phpIDoSXK [error] => 0 [size] => 3502037 ) ) 
  $err_msg = "表单不完全.请重新<a href='{$uploadpage}'>上传</a><br>";
echo $err_msg;
exit;
}

for ($i=0; $i < 5; $i++) {
  $fileImg = $_FILES['upfile1'];
  switch($fileImg['error'][$i]){
  case UPLOAD_ERR_INI_SIZE:
    $err_msg = $fileImg['name'][$i] . "文件超过最大上传限制:$maxUploadSize . 请重新<a href='{$uploadpage}'>上传</a><br>";
    break;
  case UPLOAD_ERR_PARTIAL:
    $err_msg = $fileImg['name'][$i] . "文件上传不完全.请重新<a href='{$uploadpage}'>上传</a><br>";
    break;
  case UPLOAD_ERR_NO_FILE:
    $err_msg = $fileImg['name'][$i] . "没有选择文件.请重新<a href='{$uploadpage}'>上传</a><br>";
    break;
  case UPLOAD_ERR_FORM_SIZE:
    $err_msg = $fileImg['name'][$i] . "文件超过最大上传限制.请重新<a href='{$uploadpage}'>上传</a><br>";
    break;
  case UPLOAD_ERR_CANT_WRITE:
    $err_msg = $fileImg['name'][$i] . "文件写入失败.请重新<a href='{$uploadpage}'>上传</a><br>";
    break;
  case UPLOAD_ERR_NO_TMP_DIR:
    $err_msg = $fileImg['name'][$i] . "没有临时文件夹.请重新<a href='{$uploadpage}'>上传</a><br>";
    break;
  case UPLOAD_ERR_OK:
    break;
  default:
   $err_msg = $fileImg['name'][$i] . "未知错误.请重输<a href='{$uploadpage}'>上传</a><br>";
}

//判断上传文件格式
if(!in_array($fileImg['type'][$i],array('image/jpeg','image/pjpeg','image/png'))){
  $err_msg  = "只允许上传.png或.jpg图片。请重新<a href='{$uploadpage}'>上传</a><br>";
}

print_r($fileImg['tmp_name'][$i]);

//将上传到$_FILES临时 [tmp_name]文件move到其他目录
if(!$err_msg){
  if(!move_uploaded_file($fileImg['tmp_name'][$i],$dir.$fileImg['name'][$i])){
    $err_msg = "移动文件失败$i，请重新<a href='{$uploadpage}'>上传</a><br>";
  }
}

//打开图片
if($err_msg){
  echo $err_msg;
}else{
  echo "<img src='{$fileImg['name'][$i]}' alt='上传的文件' title='上传的文件'/>";
  echo "上传成功,请继续<a href='{$uploadpage}'>上传</a><br>";
}
$err_msg = false;
}

```


### 文件的下载

```
**遍历目录**

<?php
$downdir = ".";
$dirHandle  = @opendir($downdir);
while($file = readdir($dirHandle)){
  if($file <> "." && $file <> "..")
    echo "<a href='$file'>$file</a><br>";
}
closedir($dirHandle);
?>
```

## 实例

```php
**文件系统的常见操作**

<?php
$filename = 'test.txt';
$somecontent = 'xxxxxxxx';

if (is_writable($filename)){
  if (!$handle = fopen($filename, 'a+')){       
    echo "不能打开文件:$filename";
    exit;
  }

  echo fgets($handle);      //按行来读取文件
  echo ftell($handle);      //获取当前游标
  fseek($handle,0,SEEK_CUR);                          
  echo fgets($handle);
  fseek($handle,16);
  echo fgets($handle);

  if(fwrite($handle, $somecontent) === false){
    echo "不能写入文件：$filename";
    exit();
  }
  
  echo "成功的将 $somecontent 写入到文件$filename";
  fclose($handle);
}else{ 
  echo "文件 $filename 不可写";
}

```



# 第十二章 PHP交互

## 表单数据的提交
**方法：get、post**

### get方法

HTML表单没有指定method属性，则默认使用GET方法来提交数据

### post方法

指定表单中method属性为post

## 获取表单数据
### 获取文本域的数据

```
文本域用于用户输入相关数据，有intput标签的type属性指定
<input type="text" name="text1" size="14" value="" maxlenght="15">

type为input标签的类型
name为input标签的名称
size为input标签的长度
value为input标签的初始值
maxlenght可输入内容的最大长度

密码框
<input type="password" name="password1" size="15" value="" maxlenght="10">

多行文本域
<textarea name="textarea1" cols="50" rows="10">init value</textarea>
cols列数
rows行数
init value初始值
```

```html
** 显示文本框

<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtm11/DTD/xhtm11-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>insert title here</title>
</head>
<body>
  <form name="form1" method="post" action="12.2.php">     
    用户:<br><input type="text" name="text1" size="15" maxlenght="30" value="文本默认值">
    <input type="hidden" value="默认值" name="hidden1"><br>
    密码:<br><input type="password" name="password1" size="15" maxlength="10"><br>
    个人简介:<br><textarea name="textarea1" cols="50" rows="10">init value</textarea><br />                               
    <input type="submit" name="submit1" value="提交">
  </form>
</body>
</html>
```

```
**对于表单所提交的数据，由表单action属性所指向的ULR服务器程序进行接收，使用method属性接收表单中数据，如果使用GET或属性为空，则在服务器端使用$_GET[],如果使用POST，则使用$_POST[]接收提交的数据。

**使用POST获取提交数据

<?php
header("Content-Type: text/html;charset=utf-8"); 
echo "提交的数据：<br>";
echo "姓名：" . $_POST['text1'] ."<br>";
echo "隐藏框的内容：" . $_POST['hidden1'] . "<br>";
echo "password：" . $_POST['password1'] . "<br>";
echo "个人简介：" . $_POST['textarea1'] . "<br>";
?>
```

### 获取单选按钮的数据

```
<input type="radio" name="radiobuttion" value="radiobuttion" selected>
单选按钮类型为radio
属性name为单选的名字
selected默认选中该单选框

**单选按钮的应用**


<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtm11/DTD/xhtm11-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <body>
    <form name="form1" method="post" action="12.4.php">
      <table>
        <tr><td><input type="radio" name="radiobutton1" value="单选一" selected></td><td>单选一</td></tr>
        <tr><td><input type="radio" name="radiobutton1" value="单选二"></td><td>单选二</td></tr>
        <tr><td><input type="radio" name="radiobutton1" value="单选三"></td><td>单选三</td></tr>
        <tr><td><input type="radio" name="radiobutton2" value="单选四"></td><td>单选四</td></tr>
      </table>
      <input type="submit" name="submit1" value="提交">
    </form>
  </body>
</html>
```

```php
<?php
header("Content-Type: text/html;charset=utf-8");
echo "示例12-3提交的数据:<br>";
echo "用户所选中的单选按钮内容:". $_POST['radiobutton1'] . "<br>";
echo "用户所选中的单选按钮内容:". $_POST['radiobutton2'] . "<br>";
?>
```

### 获取复选框的数据

```
<iput type="checkbox" value="checkbox1" name="checkbox1">
checkbox指定input标签为一个复选框，属性value为复选框的值
```

```html
<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtm11/DTD/xhtm11-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <title>Insert title here</title>
</head>
<form name="form1" method="post" action="12.6.php">
      <table>
        <tr><td><input type="checkbox" name="checkbox1" value="复选一"></td><td>复选一</td></tr>
        <tr><td><input type="checkbox" name="checkbox2" value="复选二"></td><td>复选二</td></tr>
        <tr><td><input type="checkbox" name="checkbox3" value="复选三"></td><td>复选三</td></tr>
        <tr><td><input type="checkbox" name="checkbox4" value="复选四"></td><td>复选四</td></tr>
      </table>
      <input type="hidden" value="4" name="checkcnt" />       <!--用于php获取数据使用-->
      <input type="submit" name="submit1" value="提交" />
    </form>
  </body>
</html>
```

```php
获取多个复选框的值

<?php
header("Content-Type: text/html;charset=utf-8");
echo "示例提交的数据：<br>";
$checkcnt=$_POST['checkcnt'];
for($i=1;$i<=$checkcnt;$i++){
  $checkbox="checkbox" . $i;
  if(isset($_POST[$checkbox])){
    echo "用户选择的第 $i 个复选框的值为：$_POST[$checkbox] <br>";
  }
}
?>
```

### 获取下拉框或列表框的数据

```html
<select name="select1" multiple size="3">
  <optgroup label="group1">
    <option value="value1">value1</option>
  </optgroup>
  <optgroup label="group2">
    <option value="value2">value2</option>
  </optgtoup>
</select>
name列表名字
size有几个下拉选项
multiple表示是一个列表框
optgroup下拉选项的分组
label显示在下拉列表中的分组名称
```

```html
下拉框和列表框
<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtm11/DTD/xhtm11-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <title>Insert title here</title>
</head>
<body>
<form name="form1" method="post" action="12.8.php">
      <select name="select1">
        <optgroup label="下拉分组一">
          <option value="选项一">选项一</option>
          <option value="选项二">选项二</option>
        </optgroup>
        <optgroup label="下拉分组二">
          <option value="选项三">选项三</option>
          <option value="选项四">选项四</option>
        </optgroup>
        </select>
        <select name="select2[ ]" multiple size="6">
          <optgroup label="下拉分组一">
            <option value="选项一">选项一</option>
            <option value="选项二">选项二</option>
          </optgroup>
          <optgroup label="下拉分组二">
            <option value="选项三">选项三</option>
            <option value="选项四">选项四</option>
          </optgroup>
        </select>
        <input type="submit" name="submit1" value="提交" />
      </form>
    </body>
    </html>
```

```php
**接收html数据**
<?php
header("Content-Type: text/html;charset=utf-8");
echo "提交的数据：<br>";
echo "下拉框选项：" . $_POST['select1'] . "<br>";
$selectcnt=count($_POST['select2']);
//echo $selectcnt . "<br>"; 
for($i=0;$i<$selectcnt;$i++){
  echo "列表框选中数据项 $i :" . $_POST['select2'][$i] .  "<br>";
}
?>
```

## 常用表单验证

```
对输入文本框的格式进行验证
```

### 用户名验证

```
int ereg(string $pattern,string  $string[, array &$args])
pattern要匹配的正则表达式，存入args数组
string为要匹配的字符串
```

```
Note: 直到 PHP 4.1.0 为止，$regs 将被填充为正好十个单元，即使实际匹配的子串少于十个。这并不影响 ereg() 匹配更多子串的能力。如果没有找到匹配，则 $regs 不会被 ereg() 更改。
```

```php
**验证匹配规则的用户名**

<?php
header("Content-Type: text/html;charset=utf-8");
$patten="/^(\d+)/";                   //用户名只能以数字开头           
if(preg_match($patten,$_POST['text1'],$arr)){
  echo "用户名：" . $_POST['text1'];
}else{
  echo "用户名格式错误；";
}
?>
```

### 密码验证

```php
**保证两次密码验证一致**

<?php
header("Content-Type: text/html;charset=utf-8");
if ($_POST['password1']==$_POST['password2']){
  echo "两次输入的密码相同.<br>";
}else{
  echo "两次输入的密码不同.<br>";
}
?>
```

### 日期验证

```
**格式YYYY-MM-DD**
([0-9](4))-([0-9](1,2))-([0-9](1,2))

<?php
header("Content-Type: text/html;charset=utf-8");
$patten="/([0-9](4))-([0-9](1,2))-([0-9](1,2))/"
if(preg_grep($patten, $_POST['date'])){
  echo "日期格式正确：" . $_POST['date'];
}else{
  echo "无效的日期格式：" . $_POST['date'];
}
?>

**说明：可以使用javascript方式让用户选择日期**
```

### E-mail验证

```php
<?php
header("Content-Type: text/html;charset=utf-8");
$pattrn="^[a-zA-Z0-9_.]+@([a-zA-Z0-9_]+.)+[a-zA-Z]{2,3}$";
if(preg_match($patten, $_POST['email'])){
  echo "邮件地址格式正确：" . $_POST['email'];
}else{
  echo "邮件地址格式无效：" . $_POST['email'];
}
?>
```

## URL编码的解码

```
**URL编码urlencode**

<?php
$str="http://stockpage.10jqka.com.cn/spService/002424/Funds/realFunds";
echo urlencode($str);
?>

运行结果：
http%3A%2F%2Fstockpage.10jqka.com.cn%2FspService%2F002424%2FFunds%2FrealFunds
```

```
**URL解码urldecode**

<?php
$str="http://stockpage.10jqka.com.cn/spService/002424/Funds/realFunds";
$urlstr=urlencode($str);
echo urldecode($urlstr);
?>

运行结果：
http://stockpage.10jqka.com.cn/spService/002424/Funds/realFunds
```

## 本章实例

```html

<html>
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <title>交互</title>
  <script language="JavaScript">
  <!--
  function del_chk(message){
    return confirm(message);
  }
  //-->
  </script>
</head>

<body>
  <?php
  $myrow[guest_name]="guest";
  $myrow[guest_time]=time();
  $guest_name=addslashes($myrow[guest_name]);
  //$guest_name=str2js($myrow[guest_name],"'");
  $dele_mess="真的要删除这个留言吗？\\n 留言姓名：$guest_name($myrow[guest_ip])"."\\n 留言时间；$myrow[guest_time]";
  echo "<script>";
  echo "delete_mess=\"$dele_mess\"";
  echo "</script>";
  ?>
  <a href="<?php echo "$PHP_SELF?opt=delete"; ?>" onClick='return del_chk(delete_mess)'>删除</a>
</body>
</html>
```


# 第十三章 cookie 与 session

### cookie

```
在远程浏览器端存储数据并以此来跟踪和识别用户的机制
cookie通过httpHeaders从服务器端返回浏览器，首先服务器端利用set-cookie header来创建一个cookie，然后浏览器在它的请求中通过cookie header包含这个已经创建的cookie，并且将它返回服务器，从而完成浏览器验证。
cooike是面向路径的，在缺省path时候，web浏览器会自动将当前路径传递给浏览。
浏览器最多创建30个cookie，每个不能超过4KB，每个web站点设置的cookie不能超过20个
```

### session

```
保存用户信息的另一种方式，将用户信息以文件的形式存储在服务器上，然后通过用户端提交session_id识别客户端的信息session可存储在cookie中，也可经过URL传递到服务器
```

1、session的选项，在php.ini中可对session进行设置

|选项名称|选项意义|
|---|---|
|session.auto_start|指定会话模块是否在请求开始时自动启动一个session，默认值为0，不自动启动。默认为1自动启动session|
|session.save_handler|定义了用来存储和获取与会话关联的数据的处理器的名字，默认为files，以文件模式保存session|
|session.save_path|定义了给存储处理器的参数，如果选择默认files文件处理器，则此值是创建文件的路径，默认为php服务器的临时目录，可将其设置为自己想要的目录，该目录需要具有可写权限|
|session.use_cookies|指定是否在客户端用cookie来存放sessionID。默认为1，允许使用。如设为0，则不可使用|
|session.name|指定会话名作cookie的名字，只能有字母或数字组成。默认为PHPSESSID，即当前的会话ID|
|session.cookie_lifetime|以秒数指定了发送到浏览器的cookie的生命周期、默认为0，即当浏览器关闭后失效|
|session.cookie_path|用于保存session的cookie的保存路径，默认值为"/"，即浏览器保存cookie的根目录|


## cookie操作

```
cookie用于保存用户状态，在php中，可直接对cookie操作，如将状态信息写入cookie、从cookie读取状态信息、设置用户状态等信息的保存时间等。
```

### 设置Cookie

```
通过setcookie函数实现
bool setcookie(string $name[, string $value[, int $expire[, string $path[, string $domain[, bool $secure[, bool $httponly]]]]]])
**注意：该函数失败返回布尔类型，在调用该函数前不能有任何输出，否则php将会给警告信息，并且cookie也不会被传送**
```

|name|为设置cookie的名字|
|---|---|
|value|为设置cookie的值|
|expire|cookie的失效时间，是个unix时间戳，采用unix经开始总秒数表示|
|path|为cookie在服务器上有效路径，设置为“/”，在整个网涨所有页面均可访问，如果设置为"/foo/",则只有此目录及其子目录下的页面可以放温暖，默认值为当前目录。|
|domain|为cookie有效的域名，要让cookie在example.com的所有子域名内有效，可设置为“example”，前面的"."不是必须的，但是为了浏览器兼容加上。|
|secure|表示cookie是否仅允许通过安全的https协议进行传输，值为true则表示只允许通过安全https协议进行传输，值为false则表示允许通过普通http协议进行传输，默认为false。|
|httponly|参数httponly表示cookie是否允许通过http协议访问，这就意味着不能再被脚本语言访问，如javascript|

```
**技巧**
如果在同一个页面中设置cookie，实际上在设置cookie时是按照从后往前的顺序进行设置的，如果先要删除一个cookie，在设置一个cookie，则必须将设置cookie的语句放在前面，删除cookie语句放在后边，否则将出现错误。
```

```
**在php脚本中设置cookie**

<?php
  echo $str="this is a test cookie.";
  setcookie("testCookie",$str);
  setcookie("testTimeCookie",$str,time() + 10);
?>
```

```
**访问cookie**
设置的cookie在其有效期内均可直接进行访问

<?php
header("Content-Type: text/html;charset=utf-8");
if(isset($_COOKIE['testCookie'])){
  echo "testCookie:" . $_COOKIE['testCookie'] . "<br>";
}else{
  echo "testCookie已过期.<br>";
}
if(isset($_COOKIE['testTimeCookie'])){
  echo "testTimeCookie:" . $_COOKIE['testTimeCookie'];
}else{
  echo "testTimeCookie已过期.<br>";
}
?>
```

### 删除cookie

```
**删除指定的cookie**
<?php
setcookie("testCookie");
setcookie("testTimeCookie");
?>

或

<?php
setcookie("testCookie",$str,time());
setcookie("testTimeCookie",$str,time() -1);
?>
```

### cookie全局数组

```
<?php
  $_COOKIE['website']="www.php.net";      //对全局数据赋值
  echo "website cookie:" . $_COOKIE['website'] . "<br>";    //调用全局数据
  print_r($_COOKIE['website']);
?>
```

## cookie的应用
**将用户信息存储在cookie中，用户可直接修改cookie文件，伪造登陆信息，进而达到通过验证的目的，这种将登陆信息存储到客户端cookie方式非常不安全**
```
**通过验证存储在cookie中的信息判断用户是否登陆**
<?php
if(isset($_COOKIE['logined']) && $_COOKIE['logined']){
  echo $_COOKIE['username'] . ", 您好，欢迎光临!";
}else{
  echo "未登录！请<a href='13.6.php'>登陆</a>.";
}

?>
```

## session操作
### session使用