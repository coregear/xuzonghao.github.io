---
layout: post
title:  "OSPF负载均衡报告v3"
date:   2014-09-09
categories: 交换机
---

OSPF负载均衡报告v3



为什么要使用OSPF做负载均衡？
	目前主流的LVS+keepalived 瓶颈在于调度器的压力。使用NAT模式，进出包受到LVS最大转发限制。使用DR模式调度器收包受到LVS最大转发限制。
为了解决上面这些问题，所以我们开始尝试LVS（DR）通过OSPF，做lvs集群，实现一个VIP，多台LVS同时工作提供服务，不存在热备机器。提高至少相当于LVS的5倍以上转发性能。



测试交换机型号：
cisco WS-C3750G-24TS 24口  全千兆



畅想:
	全万兆且支持10条以上等价路由路由设备，单口每秒1000万pps，10条等价路由每秒1亿pps。当然你也可以根据设备性能进行横向扩展或多台思科设备堆叠、聚合都是可以翻倍来提升pps性能。完全可以突破LVS+keepalived调度器存在的瓶颈。



简介:
OSPF(Open Shortest Path First开放式最短路径优先）是一个内部网关协议(Interior Gateway Protocol，简称IGP），用于在单一自治系统（autonomous system,AS）内决策路由。是对链路状态路由协议的一种实现，隶属内部网关协议（IGP），故运作于自治系统内部。著名的迪克斯加算法(Dijkstra)被用来计算最短路径树。OSPF分为OSPFv2和OSPFv3两个版本,其中OSPFv2用在IPv4网络，OSPFv3用在IPv6网络。OSPFv2是由RFC 2328定义的，OSPFv3是由RFC 5340定义的。与RIP相比，OSPF是链路状态协议，而RIP是距离矢量协议。
ECMP（Equal-CostMultipathRouting）等价多路径，存在多条不同链路到达同一目的地址的网络环境中，如果使用传统的路由技术，发往该目的地址的数据包只能利用其中的一条链路，其它链路处于备份状态或无效状态，并且在动态路由环境下相互的切换需要一定时间，而等值多路径路由协议可以在该网络环境下同时使用多条链路，不仅增加了传输带宽，并且可以无时延无丢包地备份失效链路的数据传输。



访问过程:
用户请求（VIP：7.7.7.7）到达三层交换机之后，通过对原地址、端口和目的地址、端口的hash，将链接分配到集群中的某一台服务器上，负载均衡通过内网向后端转发请求，后端再将数据返回给用户，整个会话完成。



测试环境:
网段	交换机IP	交换端口	交换属性	服务器ip	服务器网口	VIP	属性	COST
3.3.3.0/24	3.3.3.1	7	route	3.3.3.2	eth1	7.7.7.7	OSPF	2
4.4.4.0/24	4.4.4.1	8	route	4.4.4.2	eth2	7.7.7.7	OSPF	2
5.5.5.0/24	5.5.5.1	1	route	5.5.5.2	eth0	7.7.7.7	OSPF	2
6.6.6.0/24	6.6.6.1	2	route	6.6.6.2	eth0	7.7.7.7	OSPF	2
7.7.7.0/32	7.7.7.1	13/14/
15/16/17	vlan7
trunk	7.7.7.20-200	eth1/eth2/
eth3/p2p1/p2p2	　	　	　



访问图解:




部署说明:
1、OSPF下属服务器安装quagga软件，用于学习路由。

2、设置交换机需要OSPF端口启动route功能，并配置IP和OSPF学习网段。






测试工具:
1、	Pktgen 多线程内核级压测工具

2、	expect登录三层设备采集端口、内存、cpu数据




测试页面:
部署nginx展示，负载模式正常，关闭其中一台VIP，刷新1秒内调转到存活路由的对应的主机。






数据展示：
数据（数据采集24小时，1次/60s）
看图说明：in/out进/出  packets/sec 秒包数   in/总包数 out/总包数 进出总包数    mem/used/b 用内存M
交换机端口说明：1/2/7/8为压力进入口      13/14/16/17为ospf压力输出口

阐述: 13口进入1口流出，进口包数高于出口包数。原因：第一、千兆网口满载进入，通过计算分配，哈希到达出口。第二、交换机自身性能，自动调整进出负载平衡。第三、接收端口服务器网卡性能问题。

阐述：2 的 32次方，32位无符号整型来计数，4291293796就会溢出。

阐述：正常



阐述：单进双出100万pps，就不存在一些高峰低谷的问题了。

阐述：很稳定，因为双口计算outpps，所以到达4291293796*2就会溢出清零。

阐述：cpu始终保持9%-10%之间。内存峰值约33M。内存总计100M



阐述：低谷为压力脚本重启波动，总输入输出基本持平。200万pps进出口平稳。出包量略低于进包数量。

阐述：同样的溢出，因为双口计算outpps，所以到达4291293796*2就会溢出清零。进出包数量依然很平稳。

阐述：cpu和内存峰值原因是由于包数溢出清0，导致负载瞬间飙升。Cpu峰值11%，内存约34M。



阐述：进出口总包数达到约400万pps，进出包比较平稳。起伏由于压力源导致重启发包机制导致。单独端口转发基本维持在90-110万pps这个区间。但是4进还是要比4出包数多点。

阐述：因为是4个口outpps，所以4291293796*4才会溢出清0.

阐述：正常。


总结：以上1-4口压力数据取决于交换机性能、网络环境、测试服务器的影响，数据会有一定偏差。由于数据采用顺时采集，采集数据间隔会有数据变化。支持4条等价路由全千兆交换机，最大支持400万pps。



使用OSPF做负载均衡优点：
横向扩展：
	LVS调度机自由伸缩，横向线性扩展（最多机器数受限于三层设备允许的等价路由数目 maximum load-balancing ）
LVS机器同时工作，不存在备机，提高利用率
Ospf负载均衡取决于等价路由条数，默认4条，最大16条
切换灵活：
	当某台服务器故障，直接摘掉即可，路由自动会断开此条链路
转发稳定：
	硬件转发稳定性比较强
跨网工作：
	使用ospf负载均衡可以跨网段，跨机房进行业务扩展



其他说明：
华3设备ospfd调度算法的问题，一台宕机会使所有的长连接的断开重连，目前还无法解决;思科的设备已经支持一至性哈希算法，不会出现这个问题
